{"version":3,"file":"Review.js","sources":["../../../src/shared/eventBus.ts","../../../src/client/fetchConfig.ts","../../../src/client/components/Position.vue","../../../src/client/components/Review.vue","../../../src/client/components/Review.vue?vue&type=template&id=06859fa6&lang.js"],"sourcesContent":[null,null,"<!--\n文件行数 定位\n-->\n<template>\n  <div class=\"editable-lines\">\n    <span v-for=\"item in lines\" :key=\"item\">{{ item }}</span>\n  </div>\n</template>\n\n<script>\nexport default {\n  props: {\n    lines: {\n      type: Number,\n    },\n  },\n};\n</script>\n<style scoped>\n.editable-lines {\n  background-color: #fff;\n  padding: 88px 0 0 15px;\n}\n.editable-lines > span {\n  display: block;\n  height: 18px;\n}\n</style>","<template>\n  <div\n    v-if=\"eventData.status\"\n    class=\"editable-review\"\n    :style=\"{\n      'z-index': this.eventData.status ? 2 : -1,\n    }\"\n  >\n    <div class=\"editable-review-warp\">\n      <Position :lines=\"breakLines\"></Position>\n      <!-- TODO: Get English version content-->\n      <div class=\"editable-review-code\">\n        <div class=\"editable-new-code editable-review-body\">\n          <p>\n            Powered by\n            <a\n              href=\"https://github.com/veaba/vuepress-plugin-editable/\"\n              target=\"_blank\"\n            >\n              vuepress-plugin-editable\n            </a>\n            and\n            <a href=\"https://github.com/veaba/veaba-bot/\" target=\"_blank\">\n              veaba-bot\n            </a>\n          </p>\n          <!-- `<pre>` elements and content are not on the same line, there will be indentation problems.-->\n          <pre\n            class=\"editable-new-content\"\n            contenteditable=\"true\"\n            @input=\"onChange\"\n            >{{ eventData.content }}</pre\n          >\n          <!-- btn -->\n          <div class=\"editable-review-btn\">\n            <button @click=\"onApplyPullRequest\" :disabled=\"disabled\">\n              应用(Apply)\n            </button>\n            <button @click=\"closeModal\">关闭(Close)</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport {bus} from \"../../shared/eventBus\";\nimport { fetchOps } from \"../fetchConfig\";\nimport Position from \"./Position.vue\";\n\nexport default {\n  mounted() {\n    this.originContentLine = this.countOriginContent(this.eventData.content);\n    bus.$on(\"showReview\", (data) => {\n      this.eventData = data;\n      this.originContentLine = this.countOriginContent(data.content);\n      this.bodyScrollDefaultValue = this.switchBodyScroll();\n    });\n  },\n  components: { Position },\n  data() {\n    return {\n      eventData: {\n        content: \"\",\n        status: false,\n      },\n      disabled: false,\n      originContentLine: 0,\n      otherDivLine: 0,\n      bodyScrollDefaultValue: \"\",\n    };\n  },\n  computed: {\n    breakLines() {\n      return this.originContentLine + this.otherDivLine;\n    },\n  },\n  methods: {\n    /**\n     * disabled body scroll\n     * @param {boolean} true | false\n     */\n    switchBodyScroll(isReset) {\n      const body = document.querySelector(\"body\");\n      const tempOverflowValue = body.style.overflow;\n      if (isReset) {\n        body.style.overflow = this.bodyScrollDefaultValue;\n        this.$nextTick(() => {\n          this.bodyScrollDefaultValue = \"\";\n        });\n      } else {\n        body.style.overflow = \"hidden\";\n      }\n      return tempOverflowValue;\n    },\n    countOriginContent(nodeOrContent, isNode) {\n      let lines = 0;\n      if (nodeOrContent) {\n        let text = \"\";\n        if (isNode) {\n          text = nodeOrContent.textContent;\n        } else {\n          text = nodeOrContent;\n        }\n        for (let i in text) {\n          if (text[i] === \"\\n\") lines++;\n        }\n      }\n      return lines;\n    },\n    closeModal() {\n      location.reload();\n    },\n    debounce(fn, wait) {\n      let timer = 0;\n      return function (...args) {\n        if (timer) clearTimeout(timer);\n        timer = setTimeout(() => {\n          fn.apply(this, args);\n        }, wait);\n      };\n    },\n    /**\n     * contenteditable input event generate div element\n     */\n    onChange(event) {\n      this.otherDivLine = (event.target.children || []).length;\n      const firstTextNode = event.target.childNodes[0];\n      const w = this;\n      this.debounce(() => {\n        if (firstTextNode === undefined) w.originContentLine = 1;\n        w.originContentLine = w.countOriginContent(firstTextNode, true);\n      }, 100)();\n    },\n    /**\n     * apply pull request\n     */\n    onApplyPullRequest() {\n      this.disabled = true;\n      const contentNode = document.querySelector(\".editable-new-content\");\n      const content = contentNode && contentNode.innerText;\n      bus.$emit(\"showLoading\", true);\n      const { updateAPI } = this.$page.$editable || {};\n      fetch(updateAPI, {\n        body: JSON.stringify({\n          owner: this.eventData.owner,\n          repo: this.eventData.repo,\n          path: this.eventData.path,\n          content: content,\n        }),\n        method: \"POST\",\n        ...fetchOps,\n        headers: new Headers({\n          \"Access-Token\": sessionStorage.githubOAuthAccessToken,\n          \"Content-Type\": \"Application/json\",\n        }),\n      })\n        .then((res) => res.json())\n        .then((data) => {\n          this.disabled = false;\n          if (data.code === 0) {\n            this.eventData.status = false;\n            setTimeout(() => {\n              location.reload();\n            }, 5000);\n          }\n          this.switchBodyScroll();\n          bus.$emit(\"showLoading\", false);\n          bus.$emit(\"onReceive\", data, true);\n        })\n        .catch(() => {\n          bus.$emit(\"showLoading\", false);\n          this.switchBodyScroll();\n        });\n    },\n  },\n};\n</script>\n\n<style  scoped>\n.editable-review {\n  position: fixed;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.3);\n  z-index: 1;\n}\n</style>\n","<template>\n  <div\n    v-if=\"eventData.status\"\n    class=\"editable-review\"\n    :style=\"{\n      'z-index': this.eventData.status ? 2 : -1,\n    }\"\n  >\n    <div class=\"editable-review-warp\">\n      <Position :lines=\"breakLines\"></Position>\n      <!-- TODO: Get English version content-->\n      <div class=\"editable-review-code\">\n        <div class=\"editable-new-code editable-review-body\">\n          <p>\n            Powered by\n            <a\n              href=\"https://github.com/veaba/vuepress-plugin-editable/\"\n              target=\"_blank\"\n            >\n              vuepress-plugin-editable\n            </a>\n            and\n            <a href=\"https://github.com/veaba/veaba-bot/\" target=\"_blank\">\n              veaba-bot\n            </a>\n          </p>\n          <!-- `<pre>` elements and content are not on the same line, there will be indentation problems.-->\n          <pre\n            class=\"editable-new-content\"\n            contenteditable=\"true\"\n            @input=\"onChange\"\n            >{{ eventData.content }}</pre\n          >\n          <!-- btn -->\n          <div class=\"editable-review-btn\">\n            <button @click=\"onApplyPullRequest\" :disabled=\"disabled\">\n              应用(Apply)\n            </button>\n            <button @click=\"closeModal\">关闭(Close)</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport {bus} from \"../../shared/eventBus\";\nimport { fetchOps } from \"../fetchConfig\";\nimport Position from \"./Position.vue\";\n\nexport default {\n  mounted() {\n    this.originContentLine = this.countOriginContent(this.eventData.content);\n    bus.$on(\"showReview\", (data) => {\n      this.eventData = data;\n      this.originContentLine = this.countOriginContent(data.content);\n      this.bodyScrollDefaultValue = this.switchBodyScroll();\n    });\n  },\n  components: { Position },\n  data() {\n    return {\n      eventData: {\n        content: \"\",\n        status: false,\n      },\n      disabled: false,\n      originContentLine: 0,\n      otherDivLine: 0,\n      bodyScrollDefaultValue: \"\",\n    };\n  },\n  computed: {\n    breakLines() {\n      return this.originContentLine + this.otherDivLine;\n    },\n  },\n  methods: {\n    /**\n     * disabled body scroll\n     * @param {boolean} true | false\n     */\n    switchBodyScroll(isReset) {\n      const body = document.querySelector(\"body\");\n      const tempOverflowValue = body.style.overflow;\n      if (isReset) {\n        body.style.overflow = this.bodyScrollDefaultValue;\n        this.$nextTick(() => {\n          this.bodyScrollDefaultValue = \"\";\n        });\n      } else {\n        body.style.overflow = \"hidden\";\n      }\n      return tempOverflowValue;\n    },\n    countOriginContent(nodeOrContent, isNode) {\n      let lines = 0;\n      if (nodeOrContent) {\n        let text = \"\";\n        if (isNode) {\n          text = nodeOrContent.textContent;\n        } else {\n          text = nodeOrContent;\n        }\n        for (let i in text) {\n          if (text[i] === \"\\n\") lines++;\n        }\n      }\n      return lines;\n    },\n    closeModal() {\n      location.reload();\n    },\n    debounce(fn, wait) {\n      let timer = 0;\n      return function (...args) {\n        if (timer) clearTimeout(timer);\n        timer = setTimeout(() => {\n          fn.apply(this, args);\n        }, wait);\n      };\n    },\n    /**\n     * contenteditable input event generate div element\n     */\n    onChange(event) {\n      this.otherDivLine = (event.target.children || []).length;\n      const firstTextNode = event.target.childNodes[0];\n      const w = this;\n      this.debounce(() => {\n        if (firstTextNode === undefined) w.originContentLine = 1;\n        w.originContentLine = w.countOriginContent(firstTextNode, true);\n      }, 100)();\n    },\n    /**\n     * apply pull request\n     */\n    onApplyPullRequest() {\n      this.disabled = true;\n      const contentNode = document.querySelector(\".editable-new-content\");\n      const content = contentNode && contentNode.innerText;\n      bus.$emit(\"showLoading\", true);\n      const { updateAPI } = this.$page.$editable || {};\n      fetch(updateAPI, {\n        body: JSON.stringify({\n          owner: this.eventData.owner,\n          repo: this.eventData.repo,\n          path: this.eventData.path,\n          content: content,\n        }),\n        method: \"POST\",\n        ...fetchOps,\n        headers: new Headers({\n          \"Access-Token\": sessionStorage.githubOAuthAccessToken,\n          \"Content-Type\": \"Application/json\",\n        }),\n      })\n        .then((res) => res.json())\n        .then((data) => {\n          this.disabled = false;\n          if (data.code === 0) {\n            this.eventData.status = false;\n            setTimeout(() => {\n              location.reload();\n            }, 5000);\n          }\n          this.switchBodyScroll();\n          bus.$emit(\"showLoading\", false);\n          bus.$emit(\"onReceive\", data, true);\n        })\n        .catch(() => {\n          bus.$emit(\"showLoading\", false);\n          this.switchBodyScroll();\n        });\n    },\n  },\n};\n</script>\n\n<style  scoped>\n.editable-review {\n  position: fixed;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.3);\n  z-index: 1;\n}\n</style>\n"],"names":["Position","_createElementVNode","_createElementBlock","_createVNode","_createCommentVNode"],"mappings":"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"}